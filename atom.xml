<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://Orime112.github.io</id>
    <title>ä¸ªäººå°ç«™</title>
    <updated>2020-06-28T05:48:07.007Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://Orime112.github.io"/>
    <link rel="self" href="https://Orime112.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://Orime112.github.io/images/avatar.png</logo>
    <icon>https://Orime112.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, ä¸ªäººå°ç«™</rights>
    <entry>
        <title type="html"><![CDATA[nest.jsåç«¯å¼€å‘é…ç½®]]></title>
        <id>https://Orime112.github.io/post/nestjs-hou-duan-kai-fa-pei-zhi/</id>
        <link href="https://Orime112.github.io/post/nestjs-hou-duan-kai-fa-pei-zhi/">
        </link>
        <updated>2020-06-23T06:07:10.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ç¤¾åŒºç³»ç»Ÿnestjsåç«¯æ­å»º">ç¤¾åŒºç³»ç»Ÿnest.jsåç«¯æ­å»º</h1>
<p><a name="Gi1Vx"></a></p>
<h1 id="åç«¯æŠ€æœ¯æ ˆ">åç«¯æŠ€æœ¯æ ˆï¼š</h1>
<ul>
<li>nest.js</li>
<li>MySQL</li>
</ul>
<p><a name="1nByy"></a></p>
<h1 id="ä¸€-ç¯å¢ƒæ­å»º">ä¸€ã€ç¯å¢ƒæ­å»º</h1>
<ol>
<li>å…¨å±€å®‰è£…``</li>
<li>ä½¿ç”¨å‘½ä»¤<code>nestjs new project-name</code>åˆ›å»ºnestè„šæ‰‹æ¶é¡¹ç›®</li>
</ol>
<pre><code class="language-javascript">npm i -g @nestjs/cli
nest new project-name
</code></pre>
<ol start="3">
<li>é€‰æ‹©åŒ…ç®¡ç†å·¥å…·æ—¶å€™é€‰æ‹©<code>yarn</code></li>
<li>vscodeä¸­æ‰“å¼€é¡¹ç›®</li>
<li>å¯åŠ¨é¡¹ç›®ï¼š<code>yarn start</code>æˆ–<code>yarn run start</code></li>
</ol>
<p><a name="tGkB7"></a></p>
<h3 id="æ³¨æ„ç‚¹">æ³¨æ„ç‚¹</h3>
<p><a name="8dYx0"></a></p>
<h4 id="1-é…ç½®å…¨å±€è·¯ç”±">1ã€é…ç½®å…¨å±€è·¯ç”±</h4>
<ul>
<li><code>app.setGlobalPrefixï¼ˆï¼‰</code></li>
</ul>
<p><code>åªéœ€è¦åœ¨Â main.tsÂ ä¸­åŠ ä¸Šapp.setGlobalPrefix('å…¨å±€è·¯ç”±åç§°')</code><br /></p>
<p><a name="sQZxA"></a></p>
<h4 id="2-çƒ­æ›´æ–°">2ã€çƒ­æ›´æ–°ï¼š</h4>
<ul>
<li>yarn start:dev</li>
</ul>
<p><a name="RO8eJ"></a></p>
<h4 id="3-debugæ¨¡å¼">3ã€debugæ¨¡å¼ï¼š</h4>
<ul>
<li>æ ¹ç›®å½•ä¸‹.vscodeæ–‡ä»¶å¤¹æ–°å¢æ–‡ä»¶ï¼š</li>
</ul>
<p><a name="6PAaT"></a></p>
<h1 id="äºŒ-å¢é‡å¼€å‘æ–°å¢æ¨¡å—">äºŒã€å¢é‡å¼€å‘Â·æ–°å¢æ¨¡å—</h1>
<hr>
<p><a name="6OSqx"></a></p>
<h2 id="nestä¸‰å‰‘å®¢">nestä¸‰å‰‘å®¢</h2>
<ul>
<li>
<p>nest.jsä¸­æ ¸å¿ƒæ¦‚å¿µä¸ºmoduleã€controllerã€service</p>
</li>
<li>
<p><code>Controller</code>ï¼šä¼ ç»Ÿæ„ä¹‰ä¸Šçš„æ§åˆ¶å™¨ï¼Œæä¾› api æ¥å£ï¼Œè´Ÿè´£å¤„ç†è·¯ç”±ã€ä¸­è½¬ã€éªŒè¯ç­‰ä¸€äº›ç®€æ´çš„ä¸šåŠ¡ï¼›</p>
</li>
<li>
<p><code>Service</code>ï¼šåˆç§°ä¸º <code>Provider</code>ï¼Œ æ˜¯ä¸€ç³»åˆ—æœåŠ¡ã€repoã€å·¥å‚æ–¹æ³•ã€helper çš„æ€»ç§°ï¼Œä¸»è¦è´Ÿè´£å¤„ç†å…·ä½“çš„ä¸šåŠ¡ï¼Œå¦‚æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ã€äº‹åŠ¡ã€å¹¶å‘ç­‰é€»è¾‘ä»£ç ï¼›</p>
</li>
<li>
<p><code>Module</code>ï¼šè´Ÿè´£å°† <code>Controller</code> å’Œ <code>Service</code> è¿æ¥èµ·æ¥ï¼Œç±»ä¼¼äº <code>namespace</code> çš„æ¦‚å¿µï¼›</p>
</li>
</ul>
<p><a name="XR0Er"></a></p>
<h2 id="æ–°å¢useræ¨¡å—">æ–°å¢<code>user</code>æ¨¡å—</h2>
<ul>
<li>å¿«æ·æ–¹å¼ï¼šnest-cliæä¾›çš„æŒ‡ä»¤å¯ä»¥å¿«é€Ÿåˆ›å»ºæ–‡ä»¶</li>
</ul>
<pre><code class="language-javascript">nest g [æ–‡ä»¶ç±»å‹:mo,co,s] [æ–‡ä»¶å] [æ–‡ä»¶ç›®å½•(é»˜è®¤ä¸ºsrc/+ xxx)]
</code></pre>
<ul>
<li>åˆ›å»ºåŸåˆ™ï¼šå…ˆåˆ›å»ºmoduleï¼Œååˆ›å»ºserviceå’Œcontrollerï¼Œå› ä¸ºå…ˆåˆ›å»ºmoduleçš„è¯ï¼Œ moduleä¼šè¢«è‡ªåŠ¨å¼•å…¥app.module.tsï¼Œé¿å…äº†å¢é‡æ¨¡å—çš„controllerå’Œserviceé‡å¤å¼•å…¥ã€‚</li>
</ul>
<ol>
<li><code>nest g mo user api</code></li>
<li><code>nest g co user api</code></li>
<li><code>nest g s user api</code></li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1592904510523-11f20373-4ef5-4613-b2ac-7f846bc14d59.png#align=left&amp;display=inline&amp;height=300&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=472&amp;originWidth=603&amp;size=157164&amp;status=done&amp;style=none&amp;width=383" alt="image.png" loading="lazy"><br /></p>
<p><a name="oUeee"></a></p>
<h1 id="ä¸‰-è¿æ¥mysqlæ•°æ®åº“">ä¸‰ã€è¿æ¥MySQLæ•°æ®åº“</h1>
<ul>
<li>
<p>ç”±äºtypeormæ˜¯typescriptä¸­æœ€æˆç†Ÿçš„å¯¹è±¡å…³ç³»æ˜ å°„å™¨ï¼ˆORMï¼‰ï¼Œé‡‡ç”¨typescriptç¼–å†™</p>
</li>
<li>
<p>å®‰è£…ä¾èµ–åŒ…</p>
</li>
</ul>
<pre><code class="language-javascript">yarn add @nestjs/typeorm typeorm mysql
</code></pre>
<ul>
<li>@nestjs/typeormä¸»è¦æä¾›ï¼š
<ul>
<li>{ TypeOrmModule } ï¼šåœ¨app.module.tsä¸­åŠ å…¥åˆ°importæ•°ç»„é¡¹ä¸­ï¼Œè°ƒç”¨forRootæ–¹æ³•ä¼ å…¥é…ç½®é¡¹ï¼Œå¯å¯ç”¨ä¸MySQLæ•°æ®åº“çš„è¿æ¥</li>
<li>
<br />
</li>
</ul>
</li>
<li>1ã€app.module.tsä¸­å¼•å…¥å¹¶ä½¿ç”¨TypeOrmModule</li>
</ul>
<pre><code class="language-javascript">import { TypeOrmModule } from '@nestjs/typeorm'

@Module({
	imports: [TypeOrmModule.forRoot(), ]
  ...
})
</code></pre>
<ul>
<li>æ ¹ç›®å½•ä¸‹åˆ›å»º<code>ormconfig.json</code>æ–‡ä»¶ï¼Œå†™å…¥ï¼š</li>
</ul>
<pre><code class="language-javascript">
module.exports = {
  &quot;type&quot;: &quot;mysql&quot;,
  &quot;host&quot;: &quot;localhost&quot;,
  &quot;port&quot;: 3306,
  &quot;username&quot;: &quot;root&quot;,
  &quot;password&quot;: &quot;xxxx&quot;,
  &quot;database&quot;: &quot;yy_test&quot;,
  entities: process.env.NODE_ENV == 'ts-node' ? [&quot;src/entities/**/**.entity{.ts,.js}&quot;] : [&quot;dist/entities/**/**.entity{.ts,.js}&quot;], 
  &quot;synchronize&quot;: true
}
</code></pre>
<ul>
<li>src/entities/user/User.entity.tsä¸­åˆ›å»ºå®ä½“ç±»ï¼š</li>
</ul>
<pre><code class="language-javascript">import { Entity, BaseEntity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn } from &quot;typeorm&quot;;


@Entity('user')
export class UserEntity extends BaseEntity {
  /**ç”¨æˆ·è¡¨ä¸»é”®id */
  @PrimaryGeneratedColumn()
  id: number;
  /**ç”¨æˆ·å */
  @Column()
  username: string;
  /**çœŸå®å§“å */
  @Column({default: '', nullable: true})
  realname?: string;
  /**å¯†ç  */
  @Column()
  password: string;
  /**å¯†ç ç› */
  @Column({default: '', nullable: true})
  passwordSalt?: string;
  /**æ‰‹æœºå· */
  @Column({nullable: true})
  mobile?: number;
  /**ç”¨æˆ·è§’è‰² */
  // @Column({enum: [0, 1, 2, 3]}{default: '', nullable: true})
  // role?: number;
  /**åˆ›å»ºæ—¶é—´ */
  @CreateDateColumn()
  createAt: Date
  /**æ›´æ–°æ—¶é—´ */
  @UpdateDateColumn()
  updateAt: Date
  /**ç”¨æˆ·å¤´åƒ */
  @Column({default: '', nullable: true})
  avatar?: string
  /**ç”¨æˆ·ä¸ªäººä»‹ç» */
  @Column({default: '', nullable: true})
  description?: string;
}
</code></pre>
<p><a name="T227f"></a></p>
<h2 id=""></h2>
<p>:::info<br>
æ³¨æ„ï¼š<br />vscodeçš„é»˜è®¤é…ç½®ä¸­ï¼Œä¼šå±¡æ¬¡è¯»å–distç¼“å­˜ç›®å½•è€Œä¸é‡æ–°ç¼–è¯‘äº§ç”Ÿbugï¼Œéœ€è¦è®¾ç½®<br />.vscode/setting.json<br>
:::</p>
<pre><code class="language-javascript">{
    &quot;git.ignoreLimitWarning&quot;: true,
    &quot;typescript.preferences.importModuleSpecifier&quot;: &quot;relative&quot;,
    &quot;search.followSymlinks&quot;: false,
    &quot;debug.node.autoAttach&quot;: &quot;off&quot;,
    &quot;typescript.tsdk&quot;: &quot;node_modules\\typescript\\lib&quot;,
    &quot;files.autoSave&quot;: &quot;onFocusChange&quot;,
    &quot;editor.formatOnSave&quot;: true,
    &quot;editor.codeActionsOnSave&quot;: { &quot;source.fixAll.eslint&quot;: true },
    &quot;eslint.enable&quot;: true
}
</code></pre>
<br />
<p><a name="QplDP"></a></p>
<h2 id="å¼•å…¥å®ä½“ç±»å¹¶ä½¿ç”¨">å¼•å…¥å®ä½“ç±»å¹¶ä½¿ç”¨</h2>
<p><br />user.module.ts</p>
<pre><code class="language-javascript">import { Module } from '@nestjs/common';
import { UserController } from './user.controller';
import { UserService } from './user.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { UserEntity } from 'src/entities/user/User.entity';

@Module({
  imports: [TypeOrmModule.forFeature([UserEntity])],
  controllers: [UserController],
  providers: [UserService],
})
export class UserModule {}
</code></pre>
<p>user.service.ts</p>
<pre><code class="language-javascript">import { Injectable } from '@nestjs/common';
import { CreateUserDto } from 'src/common/interface/user/index.dto';
import { UserEntity } from 'src/entities/user/User.entity';
import { UserRO } from 'src/common/interface/user/index.interface';

@Injectable()
export class UserService {
  /**è·å–æ‰€æœ‰ç”¨æˆ· */
  async get(name: string) {
    console.log(name, 'name');

    if (name === 'lihua') {
      return name;
    }
    return '';
  }

  /**æ–°å¢ç”¨æˆ· */
  async create(data: CreateUserDto): Promise&lt;UserRO&gt; {
    const newData = new UserEntity();
    Object.assign(newData, data);
    const user = await UserEntity.save(newData);
    return { user };
  }
}

</code></pre>
<p><a name="1ecI4"></a></p>
<h1 id="å››-jwtå¼•å…¥å¹¶ä½¿ç”¨">å››ã€JWTå¼•å…¥å¹¶ä½¿ç”¨</h1>
<p><a name="m8RR9"></a></p>
<h2 id="1-jwtæ¦‚å¿µåŠä½¿ç”¨æµç¨‹">1ã€JWTæ¦‚å¿µåŠä½¿ç”¨æµç¨‹</h2>
<p><a name="FQSZq"></a></p>
<h3 id="jwtä½¿ç”¨æµç¨‹">JWTä½¿ç”¨æµç¨‹ï¼š</h3>
<p>æ‰€ä»¥ JWT å®ç°ã€ç™»å½•ã€‘çš„å¤§è‡´æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯ç”¨æˆ·è¿›è¡Œç™»å½•è¯·æ±‚ï¼›</li>
<li>æœåŠ¡ç«¯æ‹¿åˆ°è¯·æ±‚ï¼Œæ ¹æ®å‚æ•°æŸ¥è¯¢ç”¨æˆ·è¡¨ï¼›</li>
<li>è‹¥åŒ¹é…åˆ°ç”¨æˆ·ï¼Œå°†ç”¨æˆ·ä¿¡æ¯è¿›è¡Œç­¾è¯ï¼Œå¹¶é¢å‘ Tokenï¼›</li>
<li>å®¢æˆ·ç«¯æ‹¿åˆ° Token åï¼Œå­˜å‚¨è‡³æŸä¸€åœ°æ–¹ï¼Œåœ¨ä¹‹åçš„è¯·æ±‚ä¸­éƒ½å¸¦ä¸Š Token ï¼›</li>
<li>æœåŠ¡ç«¯æ¥æ”¶åˆ°å¸¦ Token çš„è¯·æ±‚åï¼Œç›´æ¥æ ¹æ®ç­¾è¯è¿›è¡Œæ ¡éªŒï¼Œæ— éœ€å†æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼›</li>
</ol>
<p><a name="nEbRj"></a></p>
<h3 id="jwtç»„æˆéƒ¨åˆ†">JWTç»„æˆéƒ¨åˆ†ï¼š</h3>
<p>å®é™…çš„ JWT å¤§æ¦‚å°±åƒä¸‹é¢è¿™æ ·ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/513194/1592963982283-968772ea-c76b-400a-9016-b0bcd10e2c0b.jpeg#align=left&amp;display=inline&amp;height=184&amp;margin=%5Bobject%20Object%5D&amp;originHeight=184&amp;originWidth=800&amp;size=0&amp;status=done&amp;style=none&amp;width=800" alt="" loading="lazy"><br />å®ƒæ˜¯ä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œä¸­é—´ç”¨ç‚¹ï¼ˆ<code>.</code>ï¼‰åˆ†éš”æˆä¸‰ä¸ªéƒ¨åˆ†ã€‚æ³¨æ„ï¼ŒJWT å†…éƒ¨æ˜¯æ²¡æœ‰æ¢è¡Œçš„ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†ä¾¿äºå±•ç¤ºï¼Œå°†å®ƒå†™æˆäº†å‡ è¡Œã€‚<br />JWT çš„ä¸‰ä¸ªéƒ¨åˆ†ä¾æ¬¡å¦‚ä¸‹ã€‚</p>
<blockquote>
<ul>
<li>Headerï¼ˆå¤´éƒ¨ï¼‰</li>
<li>Payloadï¼ˆè´Ÿè½½ï¼‰</li>
<li>Signatureï¼ˆç­¾åï¼‰</li>
</ul>
</blockquote>
<p>å†™æˆä¸€è¡Œï¼Œå°±æ˜¯ä¸‹é¢çš„æ ·å­ã€‚</p>
<pre><code class="language-javascript">Header.Payload.Signature
</code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/513194/1592963982355-89ebbec7-57c7-475e-8320-2a71902d26ed.jpeg#align=left&amp;display=inline&amp;height=209&amp;margin=%5Bobject%20Object%5D&amp;originHeight=209&amp;originWidth=800&amp;size=0&amp;status=done&amp;style=none&amp;width=800" alt="" loading="lazy"><br /></p>
<p><a name="dUTP9"></a></p>
<h4 id="1-header-éƒ¨åˆ†">1ã€Header éƒ¨åˆ†</h4>
<p>æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œæè¿° JWT çš„å…ƒæ•°æ®ï¼Œé€šå¸¸æ˜¯ä¸‹é¢çš„æ ·å­ã€‚</p>
<pre><code class="language-javascript">{
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>alg</code>å±æ€§è¡¨ç¤ºç­¾åçš„ç®—æ³•ï¼ˆalgorithmï¼‰ï¼Œé»˜è®¤æ˜¯ HMAC SHA256ï¼ˆå†™æˆ HS256ï¼‰ï¼›<code>typ</code>å±æ€§è¡¨ç¤ºè¿™ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰çš„ç±»å‹ï¼ˆtypeï¼‰ï¼ŒJWT ä»¤ç‰Œç»Ÿä¸€å†™ä¸º<code>JWT</code>ã€‚<br /></p>
<p><a name="Lj23v"></a></p>
<h4 id="2-payload-éƒ¨åˆ†">2ã€Payload éƒ¨åˆ†</h4>
<p>ä¹Ÿæ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®ã€‚JWT è§„å®šäº†7ä¸ªå®˜æ–¹å­—æ®µï¼Œä¾›é€‰ç”¨ã€‚</p>
<blockquote>
<ul>
<li>iss (issuer)ï¼šç­¾å‘äºº</li>
<li>exp (expiration time)ï¼šè¿‡æœŸæ—¶é—´</li>
<li>sub (subject)ï¼šä¸»é¢˜</li>
<li>aud (audience)ï¼šå—ä¼—</li>
<li>nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´</li>
<li>iat (Issued At)ï¼šç­¾å‘æ—¶é—´</li>
<li>jti (JWT ID)ï¼šç¼–å·</li>
</ul>
</blockquote>
<p>é™¤äº†å®˜æ–¹å­—æ®µï¼Œä½ è¿˜å¯ä»¥åœ¨è¿™ä¸ªéƒ¨åˆ†å®šä¹‰ç§æœ‰å­—æ®µï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p>
<pre><code class="language-javascript">{
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;admin&quot;: true
}
</code></pre>
<p>æ³¨æ„ï¼ŒJWT é»˜è®¤æ˜¯ä¸åŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»åˆ°ï¼Œæ‰€ä»¥ä¸è¦æŠŠç§˜å¯†ä¿¡æ¯æ”¾åœ¨è¿™ä¸ªéƒ¨åˆ†ã€‚<br /></p>
<p><a name="EVfgw"></a></p>
<h4 id="3-signature-éƒ¨åˆ†">3ã€Signature éƒ¨åˆ†</h4>
<p>æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾åï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹ã€‚<br />é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼ˆsecretï¼‰ã€‚è¿™ä¸ªå¯†é’¥åªæœ‰æœåŠ¡å™¨æ‰çŸ¥é“ï¼Œä¸èƒ½æ³„éœ²ç»™ç”¨æˆ·ã€‚ç„¶åï¼Œä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å…¬å¼äº§ç”Ÿç­¾åã€‚</p>
<pre><code class="language-javascript">HMACSHA256(
  base64UrlEncode(header) + &quot;.&quot; +
  base64UrlEncode(payload),
  secret)
</code></pre>
<p>ç®—å‡ºç­¾åä»¥åï¼ŒæŠŠ Headerã€Payloadã€Signature ä¸‰ä¸ªéƒ¨åˆ†æ‹¼æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ä¹‹é—´ç”¨&quot;ç‚¹&quot;ï¼ˆ<code>.</code>ï¼‰åˆ†éš”ï¼Œå°±å¯ä»¥è¿”å›ç»™ç”¨æˆ·ã€‚<br /></p>
<p><a name="I6Mwn"></a></p>
<h3 id="jwtä½¿ç”¨æ–¹å¼">JWTä½¿ç”¨æ–¹å¼</h3>
<p>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ JWTï¼Œå¯ä»¥å‚¨å­˜åœ¨ Cookie é‡Œé¢ï¼Œä¹Ÿå¯ä»¥å‚¨å­˜åœ¨ localStorageã€‚<br />æ­¤åï¼Œå®¢æˆ·ç«¯æ¯æ¬¡ä¸æœåŠ¡å™¨é€šä¿¡ï¼Œéƒ½è¦å¸¦ä¸Šè¿™ä¸ª JWTã€‚ä½ å¯ä»¥æŠŠå®ƒæ”¾åœ¨ Cookie é‡Œé¢è‡ªåŠ¨å‘é€ï¼Œä½†æ˜¯è¿™æ ·ä¸èƒ½è·¨åŸŸï¼Œæ‰€ä»¥æ›´å¥½çš„åšæ³•æ˜¯æ”¾åœ¨ HTTP è¯·æ±‚çš„å¤´ä¿¡æ¯<code>Authorization</code>å­—æ®µé‡Œé¢ã€‚</p>
<pre><code class="language-javascript">Authorization: Bearer &lt;token&gt;
</code></pre>
<p>å¦ä¸€ç§åšæ³•æ˜¯ï¼Œè·¨åŸŸçš„æ—¶å€™ï¼ŒJWT å°±æ”¾åœ¨ POST è¯·æ±‚çš„æ•°æ®ä½“é‡Œé¢ã€‚<br /></p>
<p><a name="bOzWy"></a></p>
<h3 id="jwtç‰¹ç‚¹">JWTç‰¹ç‚¹</h3>
<p>ï¼ˆ1ï¼‰JWT é»˜è®¤æ˜¯ä¸åŠ å¯†ï¼Œä½†ä¹Ÿæ˜¯å¯ä»¥åŠ å¯†çš„ã€‚ç”ŸæˆåŸå§‹ Token ä»¥åï¼Œå¯ä»¥ç”¨å¯†é’¥å†åŠ å¯†ä¸€æ¬¡ã€‚<br />ï¼ˆ2ï¼‰JWT ä¸åŠ å¯†çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½å°†ç§˜å¯†æ•°æ®å†™å…¥ JWTã€‚<br />ï¼ˆ3ï¼‰JWT ä¸ä»…å¯ä»¥ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºäº¤æ¢ä¿¡æ¯ã€‚æœ‰æ•ˆä½¿ç”¨ JWTï¼Œå¯ä»¥é™ä½æœåŠ¡å™¨æŸ¥è¯¢æ•°æ®åº“çš„æ¬¡æ•°ã€‚<br />ï¼ˆ4ï¼‰JWT çš„æœ€å¤§ç¼ºç‚¹æ˜¯ï¼Œç”±äºæœåŠ¡å™¨ä¸ä¿å­˜ session çŠ¶æ€ï¼Œå› æ­¤æ— æ³•åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åºŸæ­¢æŸä¸ª tokenï¼Œæˆ–è€…æ›´æ”¹ token çš„æƒé™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ JWT ç­¾å‘äº†ï¼Œåœ¨åˆ°æœŸä¹‹å‰å°±ä¼šå§‹ç»ˆæœ‰æ•ˆï¼Œé™¤éæœåŠ¡å™¨éƒ¨ç½²é¢å¤–çš„é€»è¾‘ã€‚<br />ï¼ˆ5ï¼‰JWT æœ¬èº«åŒ…å«äº†è®¤è¯ä¿¡æ¯ï¼Œä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—è¯¥ä»¤ç‰Œçš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT çš„æœ‰æ•ˆæœŸåº”è¯¥è®¾ç½®å¾—æ¯”è¾ƒçŸ­ã€‚å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æƒé™ï¼Œä½¿ç”¨æ—¶åº”è¯¥å†æ¬¡å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚<br />ï¼ˆ6ï¼‰ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT ä¸åº”è¯¥ä½¿ç”¨ HTTP åè®®æ˜ç ä¼ è¾“ï¼Œè¦ä½¿ç”¨ HTTPS åè®®ä¼ è¾“ã€‚<br /></p>
<p><a name="RqNC2"></a></p>
<h2 id="2-é¡¹ç›®ä¸­ä½¿ç”¨jwt">2ã€é¡¹ç›®ä¸­ä½¿ç”¨JWT</h2>
<p><a name="5kYab"></a></p>
<h3 id="a-æ”¹é€ ç”¨æˆ·æ³¨å†Œé€»è¾‘">aã€æ”¹é€ ç”¨æˆ·æ³¨å†Œé€»è¾‘</h3>
<ul>
<li>åˆ›å»ºå·¥å…·å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯åˆ¶ä½œä¸€ä¸ªéšæœºç›ï¼Œä¸€ä¸ªæ˜¯æ ¹æ®ç›æ¥åŠ å¯†å¯†ç </li>
<li>æ³¨å†Œå‰å…ˆæŸ¥è¯¢æ˜¯å¦æœ‰é‡å¤ï¼Œæœ‰çš„è¯è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œæ²¡æœ‰å°±è¿”å›undefined</li>
</ul>
<p><a name="YlpQ6"></a></p>
<h4 id="1ç¼–å†™åŠ ç›å·¥å…·å‡½æ•°">(1)ç¼–å†™åŠ ç›å·¥å…·å‡½æ•°</h4>
<p><code>yarn add cryptogram</code><br />src/common/utitls/cryptogram.ts</p>
<pre><code class="language-javascript">import * as crypto from 'crypto';

/**
 * Make Salt
 */
export function makeSalt(): string {
  return crypto.randomBytes(3).toString('base64');
}

/**
 * Encrypt password
 * @param password å¯†ç 
 * @param salt å¯†ç ç›
 */
export function encryptPassword(password: string, salt: string): string {
  if (!password || !salt) {
    return '';
  }
  const tempSalt = Buffer.from(salt, 'base64');
  return (
    // 10000 ä»£è¡¨è¿­ä»£æ¬¡æ•°ï¼Œ16ä»£è¡¨é•¿åº¦
    crypto.pbkdf2Sync(password, tempSalt, 10000, 16, 'sha1').toString('base64')
  );
}
</code></pre>
<p><a name="iZWTI"></a></p>
<h4 id="2æ³¨å†Œå‰å¯¹å¯†ç è¿›è¡ŒåŠ ç›åŠ å¯†">(2)æ³¨å†Œå‰å¯¹å¯†ç è¿›è¡ŒåŠ ç›åŠ å¯†</h4>
<p>src/api/user/User.service.ts</p>
<pre><code class="language-javascript">import { Injectable, HttpException, HttpStatus } from '@nestjs/common';
import { CreateUserDto } from 'src/common/interface/user/index.dto';
import { UserEntity } from 'src/entities/user/User.entity';
import { UserRO } from 'src/common/interface/user/index.interface';
import { makeSalt, encryptPassword } from '../../common/utils/cryptogram';

@Injectable()
export class UserService {
  /**è·å–æ‰€æœ‰ç”¨æˆ· */
  async get(name: string) {
    console.log(name, 'name');

    if (name === 'lihua') {
      return name;
    }
    return '';
  }

  /**ç”¨æˆ·æŸ¥é‡ */
  async findOne(username: string): Promise&lt;UserRO | undefined&gt; {
    const user = await UserEntity.findOne({ username });
    // console.log('æŸ¥è¯¢å¾—åˆ°çš„user', user); // æŸ¥å¾—åˆ°å°±è¿”å›æŸ¥è¯¢ç»“æœï¼ŒæŸ¥ä¸åˆ°è¿”å›undefined

    if (user) {
      return { user };
    } else {
      return undefined;
    }
  }

  /**æ–°å¢ç”¨æˆ·(æ³¨å†Œ) */
  async registrater(data: CreateUserDto): Promise&lt;UserRO&gt; {
    const { password } = data;

    const existUser = await this.findOne(data.username);
    if (existUser) {
      throw new HttpException('ç”¨æˆ·å·²å­˜åœ¨', HttpStatus.BAD_REQUEST);
    }
    const salt = makeSalt(); // åˆ¶ä½œå¯†ç ç›
    const hashPwd = encryptPassword(password, salt); // åŠ å¯†å¯†ç 
    const newData = new UserEntity();
    Object.assign(newData, data);
    newData.password = hashPwd;
    newData.salt = salt;
    const user = await UserEntity.save(newData);
    return { user };
  }
}
</code></pre>
<p><a name="7nem5"></a></p>
<h3 id="b-jwté…ç½®ä¸éªŒè¯">bã€JWTé…ç½®ä¸éªŒè¯</h3>
<ul>
<li>è£…åŒ…ï¼š<code>yarn add passport passport-jwt passport-local @nestjs/passport @nestjs/jwt -S</code></li>
<li>åŒæ—¶å®‰è£…ç±»å‹åŒ…ï¼š<code>yarn add @types/passport-jwt</code></li>
<li>åˆ›å»ºauthæƒé™éªŒè¯å·¥å…·æ¨¡å—</li>
</ul>
<pre><code class="language-javascript">nest g mo auth api
nest g s auth api
</code></pre>
<p>å‚è€ƒåœ°å€ï¼š<a href="https://docs.nestjs.cn/7/techniques">ä¸­æ–‡æ–‡æ¡£ä¸­æƒé™éªŒè¯</a><br /><code>Passport</code>æ˜¯æœ€æµè¡Œçš„ <code>node.js</code> èº«ä»½éªŒè¯åº“ï¼Œä¸ºç¤¾åŒºæ‰€ç†ŸçŸ¥ï¼Œå¹¶æˆåŠŸåœ°åº”ç”¨äºè®¸å¤šç”Ÿäº§åº”ç”¨ç¨‹åºä¸­ã€‚å°†è¿™ä¸ªåº“ä¸ä½¿ç”¨ <code>@nestjs/passport</code> æ¨¡å—çš„ <code>Nest</code> åº”ç”¨ç¨‹åºé›†æˆèµ·æ¥éå¸¸ç®€å•ã€‚åœ¨è¾ƒé«˜çº§åˆ«ï¼Œ<code>Passport</code> æ‰§è¡Œä¸€ç³»åˆ—æ­¥éª¤ä»¥ï¼š</p>
<ul>
<li>é€šè¿‡éªŒè¯ç”¨æˆ·çš„â€è¯â€(ä¾‹å¦‚ç”¨æˆ·å/å¯†ç ã€<code>JSON Web</code>ä»¤ç‰Œ( <code>JWT</code> )æˆ–èº«ä»½æä¾›è€…çš„èº«ä»½ä»¤ç‰Œ)æ¥éªŒè¯ç”¨æˆ·çš„èº«ä»½ã€‚<br /></li>
<li>ç®¡ç†ç»è¿‡èº«ä»½éªŒè¯çš„çŠ¶æ€(é€šè¿‡å‘å‡ºå¯ç§»æ¤çš„ä»¤ç‰Œï¼Œä¾‹å¦‚ <code>JWT</code>ï¼Œæˆ–åˆ›å»ºä¸€ä¸ª <code>Express</code> ä¼šè¯)<br /></li>
<li>å°†æœ‰å…³ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·çš„ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¸­è¿›ä¸€æ­¥ä½¿ç”¨<br /></li>
</ul>
<p>src/api/auth/auth.service.ts<br />ä¸»è¦å®ç°ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>validateUseræ ¹æ®ç”¨æˆ·åå’Œå¯†ç ï¼Œæ ¡éªŒç”¨æˆ·ä¿¡æ¯æ˜¯å¦äº‰å–ï¼Œè¿”å›ä¸‰ä¸ªä¸åŒçš„codeå’Œuseræ•°æ®</li>
<li>certificateå¤„ç†JWTç­¾è¯ï¼Œä¼ å…¥userå¯¹è±¡ï¼Œè¿”å›token</li>
</ul>
<pre><code class="language-javascript">import { Injectable } from '@nestjs/common';
import { UserService } from '../user/user.service';
import { JwtService } from '@nestjs/jwt';
import { encryptPassword } from '../../common/utils/cryptogram';
import { UserEntity } from '../../entities/user/User.entity';

@Injectable()
export class AuthService {
  constructor(
    private readonly userService: UserService,
    private readonly jwtService: JwtService,
  ) {}

  // JWTéªŒè¯ - Step2ï¼šæ ¡éªŒç”¨æˆ·ä¿¡æ¯
  async validateUser(username: string, password: string): Promise&lt;any&gt; {
    console.log('JWTéªŒè¯ - Step2ï¼šæ ¡éªŒç”¨æˆ·ä¿¡æ¯');
    const rawUser = await this.userService.findOne(username);
    if (rawUser) {
      const hashedPassword = rawUser.user.password;
      const salt = rawUser.user.salt;
      // é€šè¿‡å¯†ç ç›ï¼ŒåŠ å¯†ä¼ å‚ï¼Œå†ä¸æ•°æ®åº“é‡Œçš„æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦ç›¸ç­‰
      const hashPassword = encryptPassword(password, salt);
      if (hashedPassword === hashPassword) {
        // å¯†ç æ­£ç¡®
        // console.log('å¯†ç æ­£ç¡®åçš„rawUser', rawUser);
        return {
          code: 1,
          user: rawUser.user,
        };
      } else {
        // å¯†ç é”™è¯¯
        return {
          code: 2,
          user: null,
        };
      }
    } else {
      return {
        code: 3,
        user: null,
      };
    }
  }

  // JWTéªŒè¯ - step3ï¼š å¤„ç†jwtç­¾è¯
  async certificate(user: UserEntity) {
    const payload = {
      username: user.username,
      sub: user.id,
      realname: user.realname,
      role: user.role,
    };
    console.log('JWTéªŒè¯ - Step 3: å¤„ç†JWTç­¾è¯');
    try {
      const token = this.jwtService.sign(payload);
      return {
        code: 200,
        data: {
          token,
        },
        msg: 'ç™»é™†æˆåŠŸ',
      };
    } catch (error) {
      return {
        code: 600,
        msg: 'è´¦å·æˆ–å¯†ç é”™è¯¯',
      };
    }
  }
}
</code></pre>
<p>src/auth/constants.tsç¼–å†™ç­¾å‘JWTç”¨çš„å¸¸é‡</p>
<pre><code class="language-javascript">export const jwtConstants = {
  secret: 'shinobi7414', // å¯†é’¥
};

</code></pre>
<p>src/auth/jwt.strategy.tsç¼–å†™jwtè·¯ç”±å®ˆå«éªŒè¯ç­–ç•¥</p>
<ul>
<li>æŒ‡å®štokenä»BearerTokenä¸­è·å–</li>
<li>æŒ‡å®šå¯†é’¥ä»å¸¸é‡ä¸­è·å–</li>
<li>è¿”å›req.userå¯¹è±¡</li>
</ul>
<pre><code class="language-javascript">// src/logical/auth/jwt.strategy.ts
import { ExtractJwt, Strategy } from 'passport-jwt';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable } from '@nestjs/common';
import { jwtConstants } from './constants';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: jwtConstants.secret,
    });
  }

  // JWTéªŒè¯ - Step 4: è¢«å®ˆå«è°ƒç”¨
  async validate(payload: any) {
    console.log(`JWTéªŒè¯ - Step 4: è¢«å®ˆå«è°ƒç”¨`);
    return {
      userId: payload.sub,
      username: payload.username,
      realName: payload.realName,
      role: payload.role,
    };
  }
}

</code></pre>
<p>src/auth/auth.module.tsä¸­å¤„ç†ç›¸å…³ä¾èµ–</p>
<ul>
<li>æŒ‡å®štokenè¿‡æœŸæ—¶é—´ä¸º8h</li>
<li>å°†æœ¬åœ°ç­–ç•¥ã€jwtç­–ç•¥å’Œä¾èµ–çš„UserServiceå…¨éƒ¨å¼•å…¥</li>
</ul>
<pre><code class="language-javascript">import { Module } from '@nestjs/common';
import { AuthService } from './auth.service';
import { LocalStrategy } from './local.strategy';
import { JwtStrategy } from './jwt.strategy';
import { UserModule } from '../user/user.module';
import { PassportModule } from '@nestjs/passport';
import { JwtModule } from '@nestjs/jwt';
import { jwtConstants } from './constants';
import { UserService } from '../user/user.service';

@Module({
  imports: [
    PassportModule.register({ defaultStrategy: 'jwt' }),
    JwtModule.register({
      secret: jwtConstants.secret,
      signOptions: { expiresIn: '8h' }, // token è¿‡æœŸæ—¶æ•ˆ
    }),
    UserModule,
  ],
  providers: [AuthService, LocalStrategy, JwtStrategy, UserService],
  exports: [AuthService, UserService],
})
export class AuthModule {}

</code></pre>
<p><strong>å¤„ç†ä¾èµ–ï¼š</strong>Â <br />user.module.tsä¸­å»é™¤å¼•å…¥çš„UserControllerï¼Œè€Œæ˜¯æ”¾å…¥åˆ°app.module.tsä¸­æ³¨å†Œ<br /></p>
<p><a name="IRgNM"></a></p>
<h1 id="äº”-ä½¿ç”¨ä¸­é—´ä»¶-æ‹¦æˆªå™¨-è¿‡æ»¤å™¨æ‰“é€ æ—¥å¿—ç³»ç»Ÿ">äº”ã€ä½¿ç”¨ä¸­é—´ä»¶ã€æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨æ‰“é€ æ—¥å¿—ç³»ç»Ÿ</h1>
<p><a name="hdmSS"></a></p>
<h2 id="æ—¥å¿—ç³»ç»Ÿ">ğŸ“œæ—¥å¿—ç³»ç»Ÿ</h2>
<p><a name="irmRm"></a></p>
<h3 id="1-é…ç½®">1. é…ç½®</h3>
<p>å…ˆå®‰è£…ä¾èµ–åŒ…</p>
<pre><code class="language-typescript">$ yarn add log4js stacktrace-js -S
å¤åˆ¶ä»£ç 
</code></pre>
<p>åœ¨ config ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ <code>log4js.ts</code>ï¼Œç”¨äºç¼–å†™é…ç½®æ–‡ä»¶ï¼š</p>
<pre><code class="language-typescript">// config/log4js.ts
import * as path from 'path';
const baseLogPath = path.resolve(__dirname, '../../logs'); // æ—¥å¿—è¦å†™å…¥å“ªä¸ªç›®å½•
const log4jsConfig = {
  appenders: {
    console: {
      type: 'console', // ä¼šæ‰“å°åˆ°æ§åˆ¶å°
    },
    access: {
      type: 'dateFile', // ä¼šå†™å…¥æ–‡ä»¶ï¼Œå¹¶æŒ‰ç…§æ—¥æœŸåˆ†ç±»
      filename: `${baseLogPath}/access/access.log`, // æ—¥å¿—æ–‡ä»¶åï¼Œä¼šå‘½åä¸ºï¼šaccess.20200320.log
      alwaysIncludePattern: true,
      pattern: 'yyyyMMdd',
      daysToKeep: 60,
      numBackups: 3,
      category: 'http',
      keepFileExt: true, // æ˜¯å¦ä¿ç•™æ–‡ä»¶åç¼€
    },
    app: {
      type: 'dateFile',
      filename: `${baseLogPath}/app-out/app.log`,
      alwaysIncludePattern: true,
      layout: {
        type: 'pattern',
        pattern: '{&quot;date&quot;:&quot;%d&quot;,&quot;level&quot;:&quot;%p&quot;,&quot;category&quot;:&quot;%c&quot;,&quot;host&quot;:&quot;%h&quot;,&quot;pid&quot;:&quot;%z&quot;,&quot;data&quot;:\'%m\'}',
      },
      // æ—¥å¿—æ–‡ä»¶æŒ‰æ—¥æœŸï¼ˆå¤©ï¼‰åˆ‡å‰²
      pattern: 'yyyyMMdd',
      daysToKeep: 60,
      // maxLogSize: 10485760,
      numBackups: 3,
      keepFileExt: true,
    },
    errorFile: {
      type: 'dateFile',
      filename: `${baseLogPath}/errors/error.log`,
      alwaysIncludePattern: true,
      layout: {
        type: 'pattern',
        pattern: '{&quot;date&quot;:&quot;%d&quot;,&quot;level&quot;:&quot;%p&quot;,&quot;category&quot;:&quot;%c&quot;,&quot;host&quot;:&quot;%h&quot;,&quot;pid&quot;:&quot;%z&quot;,&quot;data&quot;:\'%m\'}',
      },
      // æ—¥å¿—æ–‡ä»¶æŒ‰æ—¥æœŸï¼ˆå¤©ï¼‰åˆ‡å‰²
      pattern: 'yyyyMMdd',
      daysToKeep: 60,
      // maxLogSize: 10485760,
      numBackups: 3,
      keepFileExt: true,
    },
    errors: {
      type: 'logLevelFilter',
      level: 'ERROR',
      appender: 'errorFile',
    },
  },
  categories: {
    default: {
      appenders: ['console', 'app', 'errors'],
      level: 'DEBUG',
    },
    info: { appenders: ['console', 'app', 'errors'], level: 'info' },
    access: { appenders: ['console', 'app', 'errors'], level: 'info' },
    http: { appenders: ['access'], level: 'DEBUG' },
  },
  pm2: true, // ä½¿ç”¨ pm2 æ¥ç®¡ç†é¡¹ç›®æ—¶ï¼Œæ‰“å¼€
  pm2InstanceVar: 'INSTANCE_ID', // ä¼šæ ¹æ® pm2 åˆ†é…çš„ id è¿›è¡ŒåŒºåˆ†ï¼Œä»¥å…å„è¿›ç¨‹åœ¨å†™æ—¥å¿—æ—¶é€ æˆå†²çª
};
export default log4jsConfig;
å¤åˆ¶ä»£ç 
</code></pre>
<p>ä¸Šé¢è´´å‡ºäº†æˆ‘çš„é…ç½®ï¼Œå¹¶æ ‡æ³¨äº†ä¸€äº›ç®€å•çš„æ³¨é‡Šï¼Œè¯·é…åˆ <a href="https://juejin.im/post/57b962af7db2a200542a0fb3">ã€ŠNode.js ä¹‹ log4js å®Œå…¨è®²è§£ã€‹</a> ä¸€èµ·é£Ÿç”¨ã€‚<br /><br>
<br />å‚è€ƒåœ°å€ï¼š<a href="https://juejin.im/post/5e7460a5e51d4526ca15efa3">https://juejin.im/post/5e7460a5e51d4526ca15efa3</a><br /><br>
<br /><br>
<br /></p>
<p><a name="Nvcwo"></a></p>
<h1 id="å…­-ä½¿ç”¨ç®¡é“-dtoéªŒè¯å…¥å‚">å…­ã€ä½¿ç”¨ç®¡é“ã€DTOéªŒè¯å…¥å‚</h1>
<p><a name="3DAez"></a></p>
<h3 id="1-æ¦‚å¿µ">1. æ¦‚å¿µ</h3>
<p>ç®¡é“å’Œæ‹¦æˆªå™¨æœ‰ç‚¹åƒï¼Œéƒ½æ˜¯åœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­çš„â€œå…³å¡â€ï¼Œåªä¸è¿‡å„å¸å…¶èŒã€‚<br />ç®¡é“æœ‰ä¸¤ä¸ªç±»å‹:</p>
<ul>
<li>è½¬æ¢ï¼šç®¡é“å°†è¾“å…¥æ•°æ®è½¬æ¢ä¸ºæ‰€éœ€çš„æ•°æ®è¾“å‡ºï¼›</li>
<li>éªŒè¯ï¼šå¯¹è¾“å…¥æ•°æ®è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœéªŒè¯æˆåŠŸç»§ç»­ä¼ é€’ï¼ŒéªŒè¯å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ï¼›</li>
</ul>
<p><code>ValidationPipe</code> æ˜¯ Nest.js è‡ªå¸¦çš„ä¸‰ä¸ªå¼€ç®±å³ç”¨çš„ç®¡é“ä¹‹ä¸€ï¼ˆå¦å¤–ä¸¤ä¸ªæ˜¯ <code>ParseIntPipe</code> å’Œ <code>ParseUUIDPipe</code>ï¼Œç°åœ¨è¿˜ç”¨ä¸åˆ°ï¼‰ã€‚<br /><code>ValidationPipe</code> åªæ¥å—ä¸€ä¸ªå€¼å¹¶ç«‹å³è¿”å›ç›¸åŒçš„å€¼ï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºä¸€ä¸ªæ ‡è¯†å‡½æ•°ï¼Œæ ‡å‡†ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-typescript">import { PipeTransform, Injectable, ArgumentMetadata } from '@nestjs/common';
@Injectable()
export class ValidationPipe implements PipeTransform {
  transform(value: any, metadata: ArgumentMetadata) {
    return value;
  }
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æ¯ä¸ªç®¡é“å¿…é¡»æä¾› <code>transform()</code> æ–¹æ³•ã€‚ è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>value</li>
<li>metadata</li>
</ul>
<p><code>value</code> æ˜¯å½“å‰å¤„ç†çš„å‚æ•°ï¼Œè€Œ <code>metadata</code> æ˜¯å…¶å…ƒæ•°æ®ã€‚<br /></p>
<p><a name="M6bh8"></a></p>
<h3 id="2-åˆ›å»ºç®¡é“">2. åˆ›å»ºç®¡é“</h3>
<p>ç®€å•ä»‹ç»å®Œä¸€äº›æ¦‚å¿µåï¼Œå¼€å§‹å®æˆ˜ï¼Œå…ˆåˆ›å»º pipe æ–‡ä»¶ï¼š</p>
<pre><code class="language-javascript">$ nest g pipe validation pipe
å¤åˆ¶ä»£ç 
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£…ä¸¤ä¸ªä¾èµ–åŒ…ï¼š</p>
<pre><code class="language-javascript">$ yarn add class-validator class-transformer -S
å¤åˆ¶ä»£ç 
</code></pre>
<p>ç„¶ååœ¨ <code>validation.pipe.ts</code> ä¸­ç¼–å†™éªŒè¯é€»è¾‘ï¼š</p>
<pre><code class="language-javascript">// src/pipe/validation.pipe.ts
import { ArgumentMetadata, Injectable, PipeTransform, BadRequestException } from '@nestjs/common';
import { validate } from 'class-validator';
import { plainToClass } from 'class-transformer';
import { Logger } from '../utils/log4js';
@Injectable()
export class ValidationPipe implements PipeTransform {
  async transform(value: any, { metatype }: ArgumentMetadata) {
    console.log(`value:`, value, 'metatype: ', metatype);
    if (!metatype || !this.toValidate(metatype)) {
      // å¦‚æœæ²¡æœ‰ä¼ å…¥éªŒè¯è§„åˆ™ï¼Œåˆ™ä¸éªŒè¯ï¼Œç›´æ¥è¿”å›æ•°æ®
      return value;
    }
    // å°†å¯¹è±¡è½¬æ¢ä¸º Class æ¥éªŒè¯
    const object = plainToClass(metatype, value);
    const errors = await validate(object);
    if (errors.length &gt; 0) {
      const msg = Object.values(errors[0].constraints)[0]; // åªéœ€è¦å–ç¬¬ä¸€ä¸ªé”™è¯¯ä¿¡æ¯å¹¶è¿”å›å³å¯
      Logger.error(`Validation failed: ${msg}`);
      throw new BadRequestException(`Validation failed: ${msg}`);
    }
    return value;
  }
  private toValidate(metatype: any): boolean {
    const types: any[] = [String, Boolean, Number, Array, Object];
    return !types.includes(metatype);
  }
}
</code></pre>
<ul>
<li>åœ¨ä½¿ç”¨å‚æ•°éªŒè¯çš„controllerä¸­å¼•å…¥ç®¡é“</li>
</ul>
<pre><code class="language-typescript">import { ValidationPipe } from '../../pipe/validation.pipe';

@UsePipes(new ValidationPipe())
@Post()
async create(@Body() data: CreateUserDTO)
</code></pre>
<ul>
<li>åœ¨DTOä¸­å®šä¹‰éªŒè¯è§„åˆ™ï¼š</li>
</ul>
<p>src/common/interface/user/index.dto.ts</p>
<pre><code class="language-typescript">import { IsNotEmpty, IsNumber, IsString } from 'class-validator';

export class CreateUserDTO {
  @IsNotEmpty({ message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º' })
  readonly username: string;
  @IsNotEmpty({ message: 'å¯†ç ä¸èƒ½ä¸ºç©º' })
  readonly password: string;
  readonly mobile: string;
}

export class LoginDTO {
  @IsNotEmpty({ message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º' })
  readonly username: string;
  @IsNotEmpty({ message: 'å¯†ç ä¸èƒ½ä¸ºç©º' })
  readonly password: string;
}
</code></pre>
<p><a name="QohXc"></a></p>
<h1 id="ä¸ƒ-å®ç°rbac-0">ä¸ƒã€å®ç°RBAC 0</h1>
<pre><code class="language-typescript">nest g interceptor rbac interceptor
</code></pre>
<pre><code class="language-typescript">// src/interceptor/rbac.interceptor.ts
import {
  CallHandler,
  ExecutionContext,
  Injectable,
  NestInterceptor,
  ForbiddenException,
} from '@nestjs/common';
import { Observable } from 'rxjs';

@Injectable()
export class RbacInterceptor implements NestInterceptor {
  // role[ç”¨æˆ·è§’è‰²]: 0-è¶…çº§ç®¡ç†å‘˜ | 1-ç®¡ç†å‘˜ | 2-å¼€å‘&amp;æµ‹è¯•&amp;è¿è¥ | 3-æ™®é€šç”¨æˆ·ï¼ˆåªèƒ½æŸ¥çœ‹ï¼‰
  constructor(private readonly role: number) {}
  intercept(context: ExecutionContext, next: CallHandler): Observable&lt;any&gt; {
    const req = context.getArgByIndex(1).req;
    if (req.user.role &gt; this.role) {
      console.log(`ç”¨æˆ·æƒé™ï¼š${req.user.role}ï¼ŒåŠŸèƒ½æ‰€éœ€æƒé™ï¼š${this.role}`);
      throw new ForbiddenException('å¯¹ä¸èµ·ï¼Œæ‚¨æ— æƒæ“ä½œ');
    }
    return next.handle();
  }
}

</code></pre>
<pre><code class="language-typescript">nest g guard rbac guards
</code></pre>
<pre><code class="language-typescript">// src/guards/rbac.guard.ts
import { CanActivate, ExecutionContext, Injectable, ForbiddenException } from '@nestjs/common';
import { Observable } from 'rxjs';

@Injectable()
export class RbacGuard implements CanActivate {
  // role[ç”¨æˆ·è§’è‰²]: 0-è¶…çº§ç®¡ç†å‘˜ | 1-ç®¡ç†å‘˜ | 2-å¼€å‘&amp;æµ‹è¯•&amp;è¿è¥ | 3-æ™®é€šç”¨æˆ·ï¼ˆåªèƒ½æŸ¥çœ‹ï¼‰
  constructor(private readonly role: number) {}
  canActivate(
    context: ExecutionContext,
  ): boolean | Promise&lt;boolean&gt; | Observable&lt;boolean&gt; {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    if (user.role &gt; this.role) {
      throw new ForbiddenException('å¯¹ä¸èµ·ï¼Œæ‚¨æ— æƒæ“ä½œ');
    }
    return true;
  }
}
</code></pre>
<pre><code class="language-typescript">import { RbacGuard } from '../../guards/rbac.guard';

  // æŸ¥è¯¢å•†å“åˆ—è¡¨
  @UseGuards(new RbacGuard(role.HUMAN))
  @UseGuards(AuthGuard('jwt'))

</code></pre>
<p><a name="KTz7C"></a></p>
<h1 id="å…«-è‡ªåŠ¨ç”Ÿæˆswaggeræ–‡æ¡£">å…«ã€è‡ªåŠ¨ç”Ÿæˆswaggeræ–‡æ¡£</h1>
<pre><code class="language-typescript">yarn add @nestjs/swagger swagger-ui-express -S
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆå››ï¼‰Csséªšæ“ä½œã€å›¾ç‰‡æ‡’åŠ è½½ï¼Œæ‰‹å†™promiseç­‰]]></title>
        <id>https://Orime112.github.io/post/mianshi/</id>
        <link href="https://Orime112.github.io/post/mianshi/">
        </link>
        <updated>2020-06-23T05:24:04.000Z</updated>
        <content type="html"><![CDATA[<p>ğŸ•¶â˜‚ï¸ğŸŒ‚ğŸ˜ŠğŸ¤“ğŸ¥™ğŸ¥’ğŸš£â€â™€ğŸğŸ—½<br>
<a name="mcuT8"></a></p>
<h1 id="1-csså®ç°ä¸€ä¸ªæ‰‡å½¢">1ã€Csså®ç°ä¸€ä¸ªæ‰‡å½¢</h1>
<ul>
<li>æ€è·¯ï¼šæç¤ºä¸€ä¸‹æ€è·¯ï¼Œwidthå’Œheightéƒ½è®¾ç½®ä¸º0<br>
ï¼Œborderå®½åº¦è®¾ç½®ä¸ºä¸€ä¸ªå›ºå®šå€¼ï¼Œborderè§’åº¦è®¾ç½®å’Œå®½åº¦ä¸€è‡´ï¼Œç„¶åä¸Šä¸‹å·¦å³å››ä¸ªåå‘border-colorï¼Œè®¾ç½®ä¸€ä¸ªæ–¹å‘çš„é¢œè‰²å’Œå¦å¤–æ–¹å‘çš„ä¸åŒå³å¯</li>
</ul>
<pre><code class="language-html">&lt;view class=&quot;shan&quot;&gt;&lt;/view&gt;
  
&lt;style lang=&quot;scss&quot;&gt;
  .shan{
  	width: 0px;
    height: 0px;
    border-width: 50px;
    border-radius: 50px;
    border-color: brow transparent transparent;
  }
&lt;/style&gt;
</code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1592365774236-6363bc10-fdfd-4315-b3d0-51b595b05e1c.png#align=left&amp;display=inline&amp;height=109&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=109&amp;originWidth=108&amp;size=1370&amp;status=done&amp;style=none&amp;width=108" alt="image.png" loading="lazy"><br /></p>
<p><a name="CGCi1"></a></p>
<h1 id="2-css-ä¸­transitionå’Œanimateæœ‰ä½•åŒºåˆ«animateå¦‚ä½•åœç•™åœ¨æœ€åä¸€å¸§">2ã€CSS ä¸­<code>transition</code>å’Œ<code>animate</code>æœ‰ä½•åŒºåˆ«?<code>animate</code>å¦‚ä½•åœç•™åœ¨æœ€åä¸€å¸§!</h1>
<hr>
<ul>
<li>é¡¾åæ€ä¹‰ï¼Œ Â æ˜¯ç”¨æ¥åšè¿‡æ¸¡çš„ï¼Œæ²¡æœ‰æ—¶é—´è½´çš„æ¦‚å¿µï¼Œé€šè¿‡äº‹ä»¶è§¦å‘ï¼‰ï¼ˆåªæœ‰ä¸€æ¬¡ï¼‰ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€ã€‚</li>
<li>animateæ˜¯åšåŠ¨æ•ˆçš„ï¼Œæœ‰æ—¶é—´è½´çš„æ¦‚å¿µï¼Œå¯ä»¥é‡å¤è§¦å‘å¹¶ä¸”æ‹¥æœ‰ä¸­é—´çŠ¶æ€</li>
</ul>
<p><br />è¿‡æ¸¡çš„å¼€é”€æ¯”åŠ¨æ•ˆå°,å‰è€…ä¸€èˆ¬ç”¨äºäº¤äº’å±…å¤š,åè€…ç”¨äºæ´»åŠ¨é¡µå±…å¤š;<br />è‡³äºå¦‚ä½•è®©<code>animate</code>åœç•™åœ¨æœ€åä¸€å¸§ä¹Ÿå¥½åŠ,å°±å®ƒè‡ªèº«å‚æ•°çš„ä¸€ä¸ªå€¼å°±å¯ä»¥äº†</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
  &lt;title&gt;animateåŠ¨ç”»æµ‹è¯•&lt;/title&gt;
  &lt;style&gt;
    .test {
      box-sizing: border-box;
      border: 5px solid #f00;
      padding: 5px;
      width: 100px;
      height: 100px;
      position: absolute;
      /* 
      animationå±æ€§çš„ç®€å†™å§¿åŠ¿æ’åº
      animationï¼šåæŒæ–¹å»¶ï¼Œå¾ªæ–¹çŠ¶å°¾
      animation: name duration timing-function delay iteration-count direction fill-mode;

      @keyframes name åŠ¨ç”»å
      duration æŒç»­æ—¶é—´
      timing-function åŠ¨ç”»é¢‘ç‡
      delay å»¶è¿Ÿå¤šä¹…å¼€å§‹
      iteration-count å¾ªç¯æ¬¡æ•°
      direction åŠ¨ç”»æ–¹å‘ï¼Œå¾€è¿”è¿˜æ˜¯æ­£å‘
      fill-mode ä¸€èˆ¬ç”¨æ¥å¤„ç†åœç•™åœ¨æŸä¸€å¸§ backwardsåˆ™åœç•™åœ¨é¦–å¸§,bothæ˜¯è½®æµ
      play-state running å¼€å§‹ï¼Œ pause æš‚åœã€‚ã€‚ã€‚
      */
     animation: moveChangeColor 1s ease 2.5s infinite ;
    }

    @keyframes moveChangeColor {
      from {
        top: 0%;
        left: 5%;
        background-color: #f00;
      }
      to {
        top: 0%;
        left: 50%;
        background-color: #ced;
      }
    }

  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;test&quot;&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1592366673486-8a1580ba-2e9a-468d-9762-29091861f52b.png#align=left&amp;display=inline&amp;height=136&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=136&amp;originWidth=670&amp;size=4426&amp;status=done&amp;style=none&amp;width=670" alt="image.png" loading="lazy"><br>
<a name="HY7Q2"></a></p>
<h1 id="3-jså®ç°stringtrimæ–¹æ³•">3ã€JSå®ç°String.trim()æ–¹æ³•</h1>
<ul>
<li>trimæœ¬è´¨å°±æ˜¯åœ¨å­—ç¬¦ä¸²çš„å‰åå»æ‰ç©ºæ ¼</li>
</ul>
<pre><code class="language-html">String.prototype.emuTrim = function() {
	return this.replace(/(^\s*)|(\s*$\)/g, '')
}
</code></pre>
<p><a name="gUlnN"></a></p>
<h1 id="4-virtual-dom-çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ">4ã€Virtual Dom çš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ</h1>
<p>:::info<br>
ã€ŒVirtual Dom çš„ä¼˜åŠ¿ã€å…¶å®è¿™é“é¢˜ç›®é¢è¯•å®˜æ›´æƒ³å¬åˆ°çš„ç­”æ¡ˆä¸æ˜¯ä¸Šæ¥å°±è¯´ã€Œç›´æ¥æ“ä½œ/é¢‘ç¹æ“ä½œ DOM çš„æ€§èƒ½å·®ã€ï¼Œå¦‚æœ DOM æ“ä½œçš„æ€§èƒ½å¦‚æ­¤ä¸å ªï¼Œé‚£ä¹ˆ jQuery ä¹Ÿä¸è‡³äºæ´»åˆ°ä»Šå¤©ã€‚æ‰€ä»¥é¢è¯•å®˜æ›´æƒ³å¬åˆ° VDOM æƒ³è§£å†³çš„é—®é¢˜ä»¥åŠä¸ºä»€ä¹ˆé¢‘ç¹çš„ DOM æ“ä½œä¼šæ€§èƒ½å·®ã€‚<br />é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼š<br />DOM å¼•æ“ã€JS å¼•æ“ ç›¸äº’ç‹¬ç«‹ï¼Œä½†åˆå·¥ä½œåœ¨åŒä¸€çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ JS ä»£ç è°ƒç”¨ DOM API å¿…é¡» æŒ‚èµ· JS å¼•æ“ã€è½¬æ¢ä¼ å…¥å‚æ•°æ•°æ®ã€æ¿€æ´» DOM å¼•æ“ï¼ŒDOM é‡ç»˜åå†è½¬æ¢å¯èƒ½æœ‰çš„è¿”å›å€¼ï¼Œæœ€åæ¿€æ´» JS å¼•æ“å¹¶ç»§ç»­æ‰§è¡Œè‹¥æœ‰é¢‘ç¹çš„ DOM API è°ƒç”¨ï¼Œä¸”æµè§ˆå™¨å‚å•†ä¸åšâ€œæ‰¹é‡å¤„ç†â€ä¼˜åŒ–ï¼Œ å¼•æ“é—´åˆ‡æ¢çš„å•ä½ä»£ä»·å°†è¿…é€Ÿç§¯ç´¯è‹¥å…¶ä¸­æœ‰å¼ºåˆ¶é‡ç»˜çš„ DOM API è°ƒç”¨ï¼Œé‡æ–°è®¡ç®—å¸ƒå±€ã€é‡æ–°ç»˜åˆ¶å›¾åƒä¼šå¼•èµ·æ›´å¤§çš„æ€§èƒ½æ¶ˆè€—ã€‚<br>
:::<br>
:::info<br>
å…¶æ¬¡æ˜¯ VDOM å’ŒçœŸå® DOM çš„åŒºåˆ«å’Œä¼˜åŒ–ï¼š<br>
:::<br>
:::info</p>
<ol>
<li>è™šæ‹Ÿ DOM ä¸ä¼šç«‹é©¬è¿›è¡Œæ’ç‰ˆä¸é‡ç»˜æ“ä½œ<br /></li>
<li>è™šæ‹Ÿ DOM è¿›è¡Œé¢‘ç¹ä¿®æ”¹ï¼Œç„¶åä¸€æ¬¡æ€§æ¯”è¾ƒå¹¶ä¿®æ”¹çœŸå® DOM ä¸­éœ€è¦æ”¹çš„éƒ¨åˆ†ï¼Œæœ€ååœ¨çœŸå® DOM ä¸­è¿›è¡Œæ’ç‰ˆä¸é‡ç»˜ï¼Œå‡å°‘è¿‡å¤šDOMèŠ‚ç‚¹æ’ç‰ˆä¸é‡ç»˜æŸè€—<br /></li>
<li>è™šæ‹Ÿ DOM æœ‰æ•ˆé™ä½å¤§é¢ç§¯çœŸå® DOM çš„é‡ç»˜ä¸æ’ç‰ˆï¼Œå› ä¸ºæœ€ç»ˆä¸çœŸå® DOM æ¯”è¾ƒå·®å¼‚ï¼Œå¯ä»¥åªæ¸²æŸ“å±€éƒ¨<br /><br>
:::</li>
</ol>
<p><a name="lWoYX"></a></p>
<h1 id="5-jså®ç°å›¾ç‰‡æ‡’åŠ è½½">5ã€JSå®ç°å›¾ç‰‡æ‡’åŠ è½½</h1>
<p>æœ‰æ—¶å€™ä¸€ä¸ªç½‘é¡µä¼šåŒ…å«å¾ˆå¤šçš„å›¾ç‰‡ï¼Œä¾‹å¦‚æ·˜å®äº¬ä¸œè¿™äº›è´­ç‰©ç½‘ç«™ï¼Œå•†å“å›¾ç‰‡å¤šåªä¹‹åˆå¤šï¼Œé¡µé¢å›¾ç‰‡å¤šï¼ŒåŠ è½½çš„å›¾ç‰‡å°±å¤šã€‚æœåŠ¡å™¨å‹åŠ›å°±ä¼šå¾ˆå¤§ã€‚ä¸ä»…å½±å“æ¸²æŸ“é€Ÿåº¦è¿˜ä¼šæµªè´¹å¸¦å®½ã€‚æ¯”å¦‚ä¸€ä¸ª1Må¤§å°çš„å›¾ç‰‡ï¼Œå¹¶å‘æƒ…å†µä¸‹ï¼Œè¾¾åˆ°1000å¹¶å‘ï¼Œå³åŒæ—¶æœ‰1000ä¸ªäººè®¿é—®ï¼Œå°±ä¼šäº§ç”Ÿ1ä¸ªGçš„å¸¦å®½ã€‚<br />ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œæé«˜ç”¨æˆ·ä½“éªŒï¼Œå°±å‡ºç°äº†æ‡’åŠ è½½æ–¹å¼æ¥å‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œä¼˜å…ˆåŠ è½½å¯è§†åŒºåŸŸçš„å†…å®¹ï¼Œå…¶ä»–éƒ¨åˆ†ç­‰è¿›å…¥äº†å¯è§†åŒºåŸŸå†åŠ è½½ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚<br />vueé¡¹ç›®ä¸­çš„æ‰“åŒ…ï¼Œæ˜¯æŠŠhtmlã€cssã€jsè¿›è¡Œæ‰“åŒ…ï¼Œè¿˜æœ‰å›¾ç‰‡å‹ç¼©ã€‚ä½†æ˜¯æ‰“åŒ…æ—¶æŠŠcsså’Œjséƒ½åˆ†æˆäº†å‡ éƒ¨åˆ†ï¼Œè¿™æ ·å°±ä¸è‡³äºä¸€ä¸ªcsså’Œå°±æ˜¯æ–‡ä»¶éå¸¸å¤§ã€‚ä¹Ÿæ˜¯ä¼˜åŒ–æ€§èƒ½çš„ä¸€ç§æ–¹å¼ã€‚<br />æ•ˆæœåŠ¨å›¾å¦‚ä¸‹ï¼š<br />è¿›å…¥æ­£é¢˜------æ‡’åŠ è½½<br />1.æ‡’åŠ è½½åŸç†<br />ä¸€å¼ å›¾ç‰‡å°±æ˜¯ä¸€ä¸ª<img>æ ‡ç­¾ï¼Œæµè§ˆå™¨æ˜¯å¦å‘èµ·è¯·æ±‚å›¾ç‰‡æ˜¯æ ¹æ®<img>çš„srcå±æ€§ï¼Œæ‰€ä»¥å®ç°æ‡’åŠ è½½çš„å…³é”®å°±æ˜¯ï¼Œåœ¨å›¾ç‰‡æ²¡æœ‰è¿›å…¥å¯è§†åŒºåŸŸæ—¶ï¼Œå…ˆä¸ç»™<img>çš„srcèµ‹å€¼ï¼Œè¿™æ ·æµè§ˆå™¨å°±ä¸ä¼šå‘é€è¯·æ±‚äº†ï¼Œç­‰åˆ°å›¾ç‰‡è¿›å…¥å¯è§†åŒºåŸŸå†ç»™srcèµ‹å€¼ã€‚<br />2.æ‡’åŠ è½½æ€è·¯åŠå®ç°<br />å®ç°æ‡’åŠ è½½æœ‰å››ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹ï¼š<br />1.åŠ è½½loadingå›¾ç‰‡<br />2.åˆ¤æ–­å“ªäº›å›¾ç‰‡è¦åŠ è½½ã€é‡ç‚¹ã€‘<br />3.éšå½¢åŠ è½½å›¾ç‰‡<br />4.æ›¿æ¢çœŸå›¾ç‰‡<br />1.åŠ è½½loadingå›¾ç‰‡æ˜¯åœ¨htmléƒ¨åˆ†å°±å®ç°çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š<br />2.å¦‚ä½•åˆ¤æ–­å›¾ç‰‡è¿›å…¥å¯è§†åŒºåŸŸæ˜¯å…³é”®ã€‚<br />å¼•ç”¨ç½‘å‹çš„ä¸€å¼ å›¾ï¼Œå¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹å‡ºå¯è§†åŒºåŸŸã€‚<br />å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè®©åœ¨æµè§ˆå™¨å¯è§†åŒºåŸŸçš„å›¾ç‰‡æ˜¾ç¤ºï¼Œå¯è§†åŒºåŸŸå¤–çš„ä¸æ˜¾ç¤ºï¼Œæ‰€ä»¥å½“å›¾ç‰‡è·ç¦»é¡¶éƒ¨çš„è·ç¦»top-heightç­‰äºå¯è§†åŒºåŸŸhå’Œæ»šåŠ¨åŒºåŸŸé«˜åº¦sä¹‹å’Œæ—¶è¯´æ˜å›¾ç‰‡é©¬ä¸Šå°±è¦è¿›å…¥å¯è§†åŒºäº†ï¼Œå°±æ˜¯è¯´å½“top-height&lt;=s+hæ—¶ï¼Œå›¾ç‰‡åœ¨å¯è§†åŒºã€‚<br />è¿™é‡Œä»‹ç»ä¸‹å‡ ä¸ªAPIå‡½æ•°ï¼š<br />é¡µå¯è§åŒºåŸŸå®½ï¼šdocument.body.clientWidth;<br />ç½‘é¡µå¯è§åŒºåŸŸé«˜ï¼šdocument.body.clientHeight;<br />ç½‘é¡µå¯è§åŒºåŸŸå®½ï¼šdocument.body.offsetWidth (åŒ…æ‹¬è¾¹çº¿çš„å®½);<br />ç½‘é¡µå¯è§åŒºåŸŸé«˜ï¼šdocument.body.offsetHeight (åŒ…æ‹¬è¾¹çº¿çš„å®½);<br />ç½‘é¡µæ­£æ–‡å…¨æ–‡å®½ï¼šdocument.body.scrollWidth;<br />ç½‘é¡µæ­£æ–‡å…¨æ–‡é«˜ï¼šdocument.body.scrollHeight;<br />ç½‘é¡µè¢«å·å»çš„é«˜ï¼šdocument.body.scrollTop;<br />ç½‘é¡µè¢«å·å»çš„å·¦ï¼šdocument.body.scrollLeft;<br />ç½‘é¡µæ­£æ–‡éƒ¨åˆ†ä¸Šï¼šwindow.screenTop;<br />ç½‘é¡µæ­£æ–‡éƒ¨åˆ†å·¦ï¼šwindow.screenLeft;<br />å±å¹•åˆ†è¾¨ç‡çš„é«˜ï¼šwindow.screen.height;<br />å±å¹•åˆ†è¾¨ç‡çš„å®½ï¼šwindow.screen.width;<br />å±å¹•å¯ç”¨å·¥ä½œåŒºé«˜åº¦ï¼šwindow.screen.availHeight;<br />HTMLElement.offsetTop ä¸ºåªè¯»å±æ€§ï¼Œå®ƒè¿”å›å½“å‰å…ƒç´ ç›¸å¯¹äºå…¶ offsetParent å…ƒç´ çš„é¡¶éƒ¨çš„è·ç¦»ã€‚<br />window.innerHeightï¼šæµè§ˆå™¨çª—å£çš„è§†å£ï¼ˆviewportï¼‰é«˜åº¦ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ï¼›å¦‚æœæœ‰æ°´å¹³æ»šåŠ¨æ¡ï¼Œä¹ŸåŒ…æ‹¬æ»šåŠ¨æ¡é«˜åº¦ã€‚<br />å…·ä½“å®ç°çš„jsä»£ç ä¸ºï¼š<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1592367450299-42f2feba-7781-4c7d-91b0-499480166dcf.png#align=left&amp;display=inline&amp;height=174&amp;margin=%5Bobject%20Object%5D&amp;originHeight=800&amp;originWidth=642&amp;size=0&amp;status=done&amp;style=none&amp;width=140" alt="" loading="lazy"><br />æ•ˆæœå¦‚ä¸‹ï¼š<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1592367450323-9a1269a2-3e5f-48a7-b678-290fece360bf.png#align=left&amp;display=inline&amp;height=82&amp;margin=%5Bobject%20Object%5D&amp;originHeight=466&amp;originWidth=800&amp;size=0&amp;status=done&amp;style=none&amp;width=140" alt="" loading="lazy"><br />éšç€é¼ æ ‡å‘ä¸‹æ»šåŠ¨ï¼Œå…¶ä½™å›¾ç‰‡ä¹Ÿé€æ¸æ˜¾ç¤ºå¹¶å‘èµ·è¯·æ±‚ã€‚<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1592367450272-16c3e75c-99d2-4843-982a-9151c7822163.png#align=left&amp;display=inline&amp;height=70&amp;margin=%5Bobject%20Object%5D&amp;originHeight=399&amp;originWidth=800&amp;size=0&amp;status=done&amp;style=none&amp;width=140" alt="" loading="lazy"></p>
<p><a name="3vGI2"></a></p>
<h1 id="6-ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„æ‰¾å‡ºå…·æœ‰æœ€å¤§å’Œçš„å­æ•°ç»„è¿”å›æœ€å¤§å’Œ">6ã€ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œæ‰¾å‡ºå…·æœ‰æœ€å¤§å’Œçš„å­æ•°ç»„ï¼Œè¿”å›æœ€å¤§å’Œ</h1>
<pre><code class="language-javascript">/**
 * ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„
 * æ‰¾å‡ºå…·æœ‰æœ€å¤§å’Œçš„è¿ç»­å­æ•°ç»„
 * è¿”å›æœ€å¤§å’Œ
 */
console.log('è¿›å…¥äº†jsæ–‡ä»¶');


const arr = [-2, 1, -3, 4, -1, 2, 1, -5, 4]

function maxSum(arr) {

  let sum = 0
  let max = 0

  for (let i = 0, len = arr.length; i &lt; len; i++) {
    // æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹åœ¨æ­¤éå†
    // ä»1åˆ°æœ€åä¾æ¬¡ç´¯åŠ 
    // arr[i]ä¾æ¬¡ä¸º -2, 1, -3, 4
    sum += arr[i]
    console.log(sum, i, arr[i]);
    
    if (max &lt; sum) {
      // æœ€å¤§å€¼é»˜è®¤ä¸º0ï¼Œå¦‚æœæœ€å¤§å€¼æ¯”ç°æœ‰å’Œå°äº†ï¼Œè®©æœ€å¤§å€¼ç­‰äºç°æœ‰å’Œ
      max = sum
    }
    if (sum &lt; 0) {
      // å¦‚æœsumçš„å€¼ä¸ºè´Ÿäº†ï¼Œè¯´æ˜å‰é¢çš„ç´¯åŠ å¹¶éæœ€ä½³æ–¹æ¡ˆï¼Œæ”¾å¼ƒå‰é¢ï¼Œå»åé¢å¯»æ‰¾ï¼Œè®©sumå€¼é‡æ–°ä¸º0
      sum = 0
    }
  }
  return max
}

console.log(maxSum([1, -2, 3, -4, -5]));
</code></pre>
<p><a name="BHwJJ"></a></p>
<h1 id="7-å®ç°ä¸€ä¸ªåŸºæœ¬çš„promise">7ã€å®ç°ä¸€ä¸ªåŸºæœ¬çš„promise</h1>
<hr>
<ul>
<li>åˆ†æï¼šä¸€ä¸ªåŸºæœ¬çš„promiseï¼Œæ˜¯ä¸€ä¸ªç±»ï¼Œå®ä¾‹åŒ–çš„æ—¶å€™æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­æœ‰ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºresolveå’Œreject</li>
<li>ç”¨æ³•ï¼šéœ€è¦è€ƒè™‘åˆ°ä¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­è¿›è¡Œresolveæ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦ç®¡ç†æˆåŠŸæ€å›è°ƒå‡½æ•°æ•°ç»„å’Œå¤±è´¥æ€å›è°ƒå‡½æ•°æ•°ç»„</li>
</ul>
<pre><code class="language-javascript">const promise = new Promise((resolve, reject) =&gt; {
	setTimeout(() =&gt; {
  	resolve('ok')
  }, 1000)
})
</code></pre>
<pre><code class="language-javascript">class MyPromise {
  constructor(fn) {
    this.status = 'pending'
    this.value = undefined
    this.reason = undefined

    // ä¿å­˜å¼‚æ­¥æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å›è°ƒå‡½æ•°æ•°ç»„
    this.resolvedCallbacks = []
    this.rejectedCallbacks = []

    let resolve = value =&gt; {
      if(this.status === 'pending') {
        this.status = 'fulfilled'
        this.value = value
        this.resolvedCallbacks.map(cb =&gt; cb(this.value))
      }
    }

    let reject = reason =&gt; {
      if(this.status === 'pending') {
        this.staus = 'rejected'
        this.reason = reason
        this.rejectedCallbacks.map(cb =&gt; cb(this.reason))
      }
    }
    
    try {
      fn(resolve, reject)
    } catch (err) {
      reject(err)
    }
  }

  // thenæ–¹æ³•å®ç°
  then(onFulfilled, onRejected) {
    if(this.status === 'pending') {
      this.resolvedCallbacks.push(onFulfilled)
      this.rejectedCallbacks.push(onRejected)
    }
    if(this.status === 'fulfilled') {
      onFulfilled(this.value)
    }
    if(this.status === 'rejected') {
      onRejected(this.reason)
    }
  }
}

const myPromise = new MyPromise((res, rej) =&gt; {
  setTimeout(() =&gt; {
    res('ok123')
  }, 500)
}).then(value =&gt; {
  console.log(value);
  
}, reason =&gt; {
  console.log(reason);
})


</code></pre>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1593237993358-25c33b75-d833-4f5a-a722-30041eec8ea9.png#align=left&amp;display=inline&amp;height=114&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=114&amp;originWidth=422&amp;size=37886&amp;status=done&amp;style=none&amp;width=422" alt="image.png" loading="lazy"><br /><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1593238548031-b15bfb5f-13df-4bfa-a711-88ea1d018e7f.png#align=left&amp;display=inline&amp;height=244&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=244&amp;originWidth=425&amp;size=113891&amp;status=done&amp;style=none&amp;width=425" alt="image.png" loading="lazy"><br /><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1593238617376-45f51fef-ccbe-4528-9e96-c02dcfb9e654.png#align=left&amp;display=inline&amp;height=582&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=582&amp;originWidth=576&amp;size=302789&amp;status=done&amp;style=none&amp;width=576" alt="image.png" loading="lazy"></p>
<ul>
<li>å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ç”¨åˆ°å¼‚æ­¥æœ¬èº«ï¼Œéœ€è¦setTimeout</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://cdn.nlark.com/yuque/0/2020/png/513194/1593241163054-c00c45ff-b59e-4a42-bb7a-a4be274e2963.png#align=left&amp;display=inline&amp;height=567&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=567&amp;originWidth=602&amp;size=334364&amp;status=done&amp;style=none&amp;width=602" alt="image.png" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://Orime112.github.io/post/hello-gridea/</id>
        <link href="https://Orime112.github.io/post/hello-gridea/">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="https://gridea.dev/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>Windows</strong>ï¼Œ<strong>MacOS</strong> æˆ– <strong>Linux</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>